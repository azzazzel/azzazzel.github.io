---
layout: post
title: 'Liferay GWT portlet - replacing GWT-RPC with JSON '
date: '2011-03-17 19:05:14 +0100'
mt_id: 19
blog_id: 1
post_id: 19
basename: liferay_gwt_portlet_replacing_gwt-rpc_with_json
categories:
- liferay
---
<p style="text-align: justify; "><meta http-equiv="content-type" content="text/html; charset=utf-8"><span style="font-family: Verdana; ">This is a continuation of my previous post </span><a href="/blog/2011/01/liferay_gwt_portlet_how_to_make_it_instanceable_and_use_gwt_rpc/"><span style="font-family: Verdana; ">Liferay GWT portlet - how to make it &quot;instanceable&quot; and use GWT RPC</span></a><span style="font-family: Verdana; ">. The approach described there uses Liferay specific functionality called &nbsp;</span><a href="http://longgoldenears.blogspot.com/2008/03/portaldelegateservlet-servlet-session.html"><span style="font-family: 'Courier New'; ">PortalDelegateServlet</span></a><span style="font-family: Verdana; ">. This way one can easily use GWT RPC which somewhat simplifies client-server communication. However if you need to develop a JSR 286 portlet you need a more standard compatible way of doing AJAX calls. For this reason JSR 286 defines <span style="font-family: 'Courier New'; ">serverResource</span> method and this post will show how to refactor the code to replace GWT RPC calls with exchanging JSON messages using serverResource method.</span></meta></p>

<!--more-->

<p><span style="font-size: medium; "><span style="font-family: Verdana; "><u><b>Let GWT know the prtlet URLs</b></u></span></span><span style="font-family: Verdana; "><br /> </span></p> <p style="text-align: justify; "><span style="font-family: Verdana; ">First thing to do is to tell GWT what are the proper URLs to call the portlet. Therefore creating a&nbsp;</span> <meta http-equiv="content-type" content="text/html; charset=utf-8"><span style="font-family: 'Courier New'; ">Chatroom</span><span style="font-family: Verdana; ">&nbsp;instance based on portlet id only, is no longer enough. To overcome this you need to provide a JavaScript object holding portlet URLs. </span><i><span style="font-family: Verdana; ">I, for example, have called it&nbsp;<span style="font-size: small; "><span style="font-family: 'Courier New'; "><span class="Apple-style-span" style="line-height: 17px; white-space: pre; color: rgb(0, 0, 0); ">ChatroomPortlet</span></span></span>&nbsp;and it's defined in&nbsp;</span></i><span class="Apple-style-span" style="font-family: Verdana; "><a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/df808f66e36b1e0257c3d31bcd869779960f08a8/docroot/js/chatrooms.js"><i>chatrooms.js</i></a></span><i><span class="Apple-style-span" style="font-family: Verdana; ">&nbsp;file. </span></i> </meta></p> <p style="text-align: justify; "><span class="Apple-style-span" style="font-family: Verdana; ">Then, in <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/df808f66e36b1e0257c3d31bcd869779960f08a8/docroot/view.jsp">view.jsp</a>, create and store that object instead of portlet id. <i>Of course for the purpose of this example only <span style="font-family: 'Courier New'; ">resourceURL</span> is needed but in a real world scenario you'll probably also need <span style="font-family: 'Courier New'; ">renderURL</span> and <span style="font-family: 'Courier New'; ">actionURL</span>.</i> To map this JavaScript object to GWT class create JSNI class&nbsp;</span><span class="Apple-style-span" style="font-family: Verdana; "><a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/df808f66e36b1e0257c3d31bcd869779960f08a8/docroot/WEB-INF/src/com/commsen/sample/portlet/chatrooms/client/ChatroomJsObject.java">ChatroomJsObject</a></span></p> <p><meta http-equiv="content-type" content="text/html; charset=utf-8" /></p> <p><meta http-equiv="content-type" content="text/html; charset=utf-8" /></p> <p><meta http-equiv="content-type" content="text/html; charset=utf-8" /></p> <p style="text-align: justify; "><span style="font-family: Verdana; ">Next you need to modify <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/df808f66e36b1e0257c3d31bcd869779960f08a8/docroot/WEB-INF/src/com/commsen/sample/portlet/chatrooms/client/Chatroom.java"><span style="font-family: 'Courier New'; ">Chatroom</span>'s</a> constructor to accept <span style="font-family: 'Courier New'; ">ChatroomJsObject</span> instead of <span style="font-family: 'Courier New'; ">String</span> representing portlet id. Of course this reflects how <span style="font-family: 'Courier New'; "><a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/df808f66e36b1e0257c3d31bcd869779960f08a8/docroot/WEB-INF/src/com/commsen/sample/portlet/chatrooms/client/GWTEntryPoint.java">GWTEntryPoint</a></span> creates <span style="font-family: 'Courier New'; ">Chatroom</span> instances.&nbsp;</span></p> <p style="text-align: justify; "><span style="font-family: Verdana; ">Have a look at <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/commit/df808f66e36b1e0257c3d31bcd869779960f08a8">my commit</a> to see what has changed.</span></p> <p style="text-align: justify; ">&nbsp;</p>   <h2><span style="font-size: medium; "><span style="font-family: Verdana; "><u><b>Create the JSR 286 portlet</b></u></span></span></h2> <p style="text-align: justify; "><span class="Apple-style-span" style="font-family: Verdana; ">Now you need to write a portlet and implement <span style="font-family: 'Courier New'; ">serveResource</span> method. Basically the method contains the same logic that used to be in <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/9a084048e203bbf3c6642c522ceb60c51e8a480b/docroot/WEB-INF/src/com/commsen/sample/portlet/chatrooms/server/ChatroomServiceImpl.java">ChatroomServiceImpl</a>. The only difference is that now it gets its input form JSON object and responds with JSON object. The portlet code is available <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/7da4cef3a7b9978da60c553d1704778ad280af30/docroot/WEB-INF/src/com/commsen/sample/portlet/chatrooms/server/ChatroomPortlet.java">here</a>.&nbsp;</span><span style="font-family: Verdana; ">Of course don't forget to replace the default <span style="font-family: 'Courier New'; ">MVCPortlet</span> with your own in <span style="font-family: 'Courier New'; "><a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/7da4cef3a7b9978da60c553d1704778ad280af30/docroot/WEB-INF/portlet.xml">portlet.xml</a></span> </span><span class="Apple-style-span" style="font-family: Verdana; ">&nbsp;&nbsp;</span></p> <p style="text-align: justify; "><span style="font-family: Verdana; ">Again <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/commit/7da4cef3a7b9978da60c553d1704778ad280af30">there is commit</a> which does above modifications, so you can check what has changed.</span></p> <p style="text-align: justify; ">&nbsp;</p> <h2><span style="font-size: medium; "><span style="font-family: Verdana; "><u><b>Update GWT client-server calls&nbsp;</b></u></span><span class="Apple-style-span" style="font-family: Verdana; ">&nbsp;</span></span></h2> <p style="text-align: justify; "><span style="font-family: Verdana; ">Having the portlet ready, it's time to change the GWT code to send and receive JSON to <span style="font-family: 'Courier New'; ">resourceURL</span> instead of using GWT RPC. For this to work you need to add 2 GWT modules to <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/03a0e357411efae82fdd8160620b81c5b8e2b64b/docroot/WEB-INF/src/com/commsen/sample/portlet/chatrooms/Chatrooms.gwt.xml">Chatrooms.gwt.xml</a>:&nbsp;</span></p> <p><code class="blockWhite"><span style="font-family: Verdana; ">&lt;inherits name=&quot;com.google.gwt.http.HTTP&quot; /&gt;<br /> </span><span class="Apple-style-span" style="font-family: Verdana; ">&lt;inherits name=&quot;com.google.gwt.json.JSON&quot; /&gt;&nbsp;</span></code></p> <p style="text-align: justify; "><span class="Apple-style-span" style="font-family: Verdana; ">To be able to convert JSON response to GWT class you'll have to provide another JSNI class <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/03a0e357411efae82fdd8160620b81c5b8e2b64b/docroot/WEB-INF/src/com/commsen/sample/portlet/chatrooms/client/ChatroomMessageJsObject.java">ChatroomMessageJsObject</a>.&nbsp;Finally the <span style="font-family: 'Courier New'; ">Chatroom</span> class itself needs to be updated:</span></p> <ul>     <li style="text-align: justify; "><span style="font-family: Verdana; ">replace the body of <span style="font-family: 'Courier New'; ">sendMessageToServer</span> method to create JSON object and send it to the portlet bu using RequestBuilder</span></li>     <li style="text-align: justify; "><span class="Apple-style-span" style="font-family: Verdana; ">replace the body of <span style="font-family: 'Courier New'; ">getMessages</span> method to covert JSON object from response to list of ChatroomMessageJsObject to be displayed.</span></li>     <li style="text-align: justify; "><span class="Apple-style-span" style="font-family: Verdana; ">convert <span style="font-family: 'Courier New'; ">lastMessageTime</span> form <span style="font-family: 'Courier New'; ">Date</span> to <span style="font-family: 'Courier New'; ">long</span> as there are some issues with passing dates in JSON</span></li> </ul> <p style="text-align: justify; "><span style="font-family: Verdana; ">As usual you can refer to <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/commit/03a0e357411efae82fdd8160620b81c5b8e2b64b">my commit</a> to get an idea what and how has changed.&nbsp;</span></p> <p style="text-align: justify; "><span style="font-family: Verdana; ">&nbsp;</span></p> <p style="text-align: justify; "><span style="font-family: Verdana; ">That's it. You are ready. Optionally you can do some cleanup by removing unused classes <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/commit/aa6b4a76b195316446df10e21b20d905e4ba77be">like I did</a>. &nbsp; &nbsp;</span></p> <p style="text-align: justify; ">&nbsp;</p>
