---
layout: post
title: Liferay - preserve GWT portlet state between reloads
date: '2011-03-23 07:53:31 +0100'
mt_id: 20
blog_id: 1
post_id: 20
basename: liferay_preserve_gwt_portlet_state_between_reloads
categories:
- liferay
- tips_and_tricks
---
<p>One of the problems with GWT <i>(which is even more noticeable in portal environment)</i> is preserving it's&nbsp;state&nbsp;between page reloads. In a GWT-only application <i>(or single portlet on the page case)</i> one can give user no other option but using only GWT controls to practically avoid page reloads. In most cases however this is not really possible nor wise thing to do. In portlet environments in particular, reloading the page is a very commmon thing to do, giving all portlets a chance to refresh their content after some action has taken place. The thing is, GWT portlets will, by default, render their initial state, which may not be what user expects. &nbsp; &nbsp; &nbsp;</p><p><meta http-equiv="content-type" content="text/html; charset=utf-8" /></p><p>For example, consider the GWT <span style="font-family: 'Courier New'; ">Chatroom</span> portlet I was using in my previous posts&nbsp;<meta http-equiv="content-type" content="text/html; charset=utf-8"><a style="text-decoration: underline; outline-style: none; outline-width: initial; outline-color: initial; color: rgb(61, 123, 34); " href="/blog/2011/01/liferay_gwt_portlet_how_to_make_it_instanceable_and_use_gwt_rpc/"><span style="font-family: Verdana; ">Liferay GWT portlet - how to make it &quot;instanceable&quot; and use GWT RPC</span></a><span style="font-family: Verdana; ">&nbsp;and&nbsp;<a style="text-decoration: underline; outline-style: none; outline-width: initial; outline-color: initial; color: rgb(61, 123, 34); " href="/blog/2011/03/liferay_gwt_portlet_replacing_gwt-rpc_with_json/">Liferay GWT portlet - replacing GWT-RPC with JSON</a>.</span>&nbsp;Imagine user has entered a chatroom. Then she clicks on some other portlet on the page. The page is reloaded and <span style="font-family: 'Courier New'; ">Chatroom</span> portlet returns to it's initial state. The user will have to enter the room again every time she clicks on another portlet. Let's see how this can be fixed.</meta></p>

<!--more-->

<p>Many people think about GWT state as a summary of the states of all used GWT widgets (text fields, combo boxes, grids, tabs, ...). Instead I prefer to think in terms of application or &quot;business logic&quot; states. If you change the point of view, it may turn around not all GUI components contain significant information that must be saved and restored. For example it may be not so important to have particular tab selected or value of particular text box updated. &nbsp; &nbsp;</p><p>In case of <span style="font-family: 'Courier New'; ">Chatroom</span> portlet, there are 2 states:</p><ul><li><span style="font-family: 'Courier New'; ">initial state</span> - the user is not in a chatroom (she may never entered one or just left one)</li><li><span style="font-family: 'Courier New'; ">chatroom entered</span> &nbsp;- the user is&nbsp;<meta http-equiv="content-type" content="text/html; charset=utf-8">in a chatroom&nbsp;&nbsp;</meta></li></ul><p>In fact this is made very clear in the code by providing 2 methods&nbsp;<span style="font-family: 'Courier New'; "><a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/master/docroot/WEB-INF/src/com/commsen/sample/portlet/chatrooms/client/Chatroom.java#L180">displayInitialState</a></span> and <span style="font-family: 'Courier New'; "><a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/master/docroot/WEB-INF/src/com/commsen/sample/portlet/chatrooms/client/Chatroom.java#L167">displayChatroomState</a></span> responsible for rendering appropriate GUI elements in particular states. Up until now during <span style="font-family: 'Courier New'; ">Chatroom</span> initialization the&nbsp;<span class="Apple-style-span" style="font-family: 'Courier New'; "><a style="text-decoration: underline; outline-style: none; outline-width: initial; outline-color: initial; color: rgb(61, 123, 34); " href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/master/docroot/WEB-INF/src/com/commsen/sample/portlet/chatrooms/client/Chatroom.java#L180">displayInitialState</a>&nbsp;</span>method was called. To fix the above problem the&nbsp;<meta http-equiv="content-type" content="text/html; charset=utf-8">initialization&nbsp;has to be changed to call appropriate method depending on what is the current state. The question is where <i>(on the client side)</i> one can store portlet state information so it survives page reloads.</meta></p><p>The obvious answer is &quot;cookies&quot;. However it has some drawbacks <i>(the major one being the fact that they may be unsupported/disabled in some browsers)</i>. Fortunately back in 2008&nbsp;<a href="http://www.thomasfrank.se/about.html">Thomas Frank</a>&nbsp;wrote and made public a very clever JavaScript library called&nbsp;<a href="http://www.thomasfrank.se/sessionvars.html">sessvars.js</a>&nbsp;which uses <span style="font-family: 'Courier New'; ">widow.name</span> property to store information that need to survive page reloads. In order to use it in the portlet it has to be added to the page and this is what <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/commit/5fc9f5914f7d38e354b6398616d03528ff36d8fd">this commit</a> does.</p><p>Now in order to actually save and load portlet state, the <span style="font-family: 'Courier New'; ">ChatroomPortlet</span>&nbsp;object&nbsp;(defined &nbsp;in <span style="font-family: 'Courier New'; "><a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/eebb9c725b46a937c948977f3f47a703d34884e1/docroot/js/chatrooms.js">chatrooms.js</a>)</span>&nbsp;has to be extended with 2 new methods: <span style="font-family: 'Courier New'; ">setState</span> and <span style="font-family: 'Courier New'; ">getState.</span>&nbsp;These methods respectively write to or read from a map<i> (key being portlet id and value portlet state)</i> which thanks to&nbsp;<a style="text-decoration: underline; outline-style: none; outline-width: initial; outline-color: initial; color: rgb(61, 123, 34); " href="http://www.thomasfrank.se/sessionvars.html">sessvars.js</a>&nbsp;can survive page reloads.&nbsp;</p><p>Having this prepared, the&nbsp;<span style="font-family: 'Courier New'; ">Chatroom</span> class can be refactored to render portlet differently depending on it's state. This can be combined with GWT's history mechanism to handle clicks on browser's back and forward buttons. <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/blob/eebb9c725b46a937c948977f3f47a703d34884e1/docroot/WEB-INF/src/com/commsen/sample/portlet/chatrooms/client/Chatroom.java">This is how modified the code looks like</a>. Basically the steps were as follows:</p><ul><li>provide&nbsp;<span style="font-family: 'Courier New'; ">saveState</span> method to both save the current state and add history token</li><li>call <span style="font-family: 'Courier New'; ">saveState</span>&nbsp;method every time portlet state changes</li><li>provide&nbsp;<span style="font-family: 'Courier New'; ">handleState</span> method to render portlet UI according to current state&nbsp;</li><li>make&nbsp;<meta http-equiv="content-type" content="text/html; charset=utf-8"><span style="font-family: 'Courier New'; ">Chatroom</span>&nbsp;class implement&nbsp;<span style="font-family: 'Courier New'; ">ValueChangeHandler</span> and provide&nbsp;<span style="font-family: 'Courier New'; ">onValueChange</span>&nbsp;method to handle history tokens.&nbsp;</meta></li><li>provide <span style="font-family: 'Courier New'; ">getStateFromToken</span> method to retrieve the portlet state from history token.&nbsp;</li></ul><p><meta http-equiv="content-type" content="text/html; charset=utf-8" /></p><p><meta http-equiv="content-type" content="text/html; charset=utf-8" /></p><p><meta http-equiv="content-type" content="text/html; charset=utf-8" /></p><p><meta http-equiv="content-type" content="text/html; charset=utf-8" /></p><p>&nbsp;All of the above mentioned changes are in <a href="https://github.com/azzazzel/gwt-chatrooms-portlet/commit/eebb9c725b46a937c948977f3f47a703d34884e1">this commit</a>. Feel free to explore what has changed and how.&nbsp;</p>
